# Ralph Progress Log
Started: 01/15/2026 18:58:33
---

## Codebase Patterns
- Turborepo pipeline: build depends on ^build, lint and test run in parallel
- ESLint uses .eslintrc.cjs (CommonJS) due to root package.json "type": "module"
- tsconfig.node.json requires composite: true for project references
- tsconfig.base.json has noEmit: true; packages must override with noEmit: false
- pnpm workspaces: apps/* and packages/*
- Shared types in packages/shared (@decisions/shared), packages/types (@decisions/types), packages/supabase (@decisions/supabase)
- Root scripts: dev, build, lint, test, format
- API uses moduleResolution: "bundler" (no .js extensions in imports)
- External clients (Supabase, AssemblyAI) are lazily initialized for flexibility
- Supabase client factory in @decisions/supabase: createBrowserClient (web), createAdminClient (api)
- Vitest for unit testing: web uses jsdom environment, api uses node environment
- Test files in __tests__ directories, use *.test.ts(x) pattern
- Fastify routes can be tested with app.inject() without HTTP
- Playwright E2E tests in apps/e2e, run with `pnpm test:e2e`
- Playwright webServer auto-starts frontend (5173) and backend (3001) for tests
- @fastify/env with dotenv: true for env validation; config accessed via server.config
- Environment files: apps/web/.env.local (VITE_*), apps/api/.env (server-side)
- Supabase project: doqojfsldvajmlscpwhu (Decision Intelligence Journal)
- Supabase migrations: supabase/migrations/*.sql, applied via MCP apply_migration
- RLS policies: use (SELECT auth.uid()) = id (wrapped select for performance)
- Trigger function update_updated_at_column() is reusable for all tables
- Case-sensitive table names require double quotes: "DecisionsUserProfiles"
- Supabase Storage: bucket "decision-audio" for audio files, private with RLS
- Storage RLS: use storage.foldername(name)[1] = auth.uid()::text for user folder checks
- @fastify/jwt v8.x for Fastify 4.x (v9.x+ requires Fastify 5.x)
- Auth plugin: authenticate decorator for protected routes, jwtUser property on request
- Supabase JWT: sub = user ID, email, phone, role, aal, session_id, app_metadata, user_metadata

---

## 01/15/2026 - US-001
Iteration: 1
- What was implemented:
  - Added .nvmrc with Node.js 20.x
  - Added `dist` to .gitignore
  - Added `test` task to turbo.json pipeline
  - Added `test` script to root package.json
  - Fixed .eslintrc.js -> .eslintrc.cjs for CommonJS compatibility
  - Fixed tsconfig.node.json composite setting for project references
  - Removed unused type imports to fix TypeScript errors
  - Fixed lint errors (curly braces, unescaped entities)
- Files changed:
  - .nvmrc (new)
  - .eslintrc.cjs (renamed from .eslintrc.js)
  - .gitignore
  - turbo.json
  - package.json
  - apps/web/tsconfig.node.json
  - apps/web/src/App.tsx
  - apps/web/src/hooks/useVoiceRecorder.ts
  - apps/web/src/pages/Dashboard.tsx
  - apps/api/src/routes/health.ts
- **Learnings for future iterations:**
  - ESLint config must be .cjs (CommonJS) when root package.json has "type": "module"
  - tsconfig.node.json needs composite: true and cannot have noEmit: true when used as project reference
  - noUnusedLocals in tsconfig catches unused type aliases - remove them rather than adding eslint-disable
  - Build errors for unused variables are TypeScript errors (TS6133, TS6196), not ESLint errors
---

## 01/15/2026 - US-002
Iteration: 2
- What was implemented:
  - Fixed package.json name from "web" to "@decisions/web" for workspace consistency
  - Updated vite.config.ts port from 5172 to 5173 (standard Vite port)
  - Added proxy configuration for /api requests to localhost:3001
- Files changed:
  - apps/web/package.json
  - apps/web/vite.config.ts
- **Learnings for future iterations:**
  - Frontend app already existed with most setup done, just needed workspace name fix
  - Vite proxy configuration in server.proxy handles API forwarding
  - Use `pnpm --filter @decisions/web dev` to run just the frontend
---

## 01/15/2026 - US-003
Iteration: 3
- What was implemented:
  - Fixed package.json name from "api" to "@decisions/api" for workspace consistency
  - Added @fastify/env dependency for environment variable handling
  - Changed tsconfig.json to use moduleResolution: "bundler" and module: "ESNext"
  - Updated all imports to remove .js extensions (bundler resolution doesn't need them)
  - Made Supabase and AssemblyAI clients lazily initialized to allow server startup without env vars
- Files changed:
  - apps/api/package.json
  - apps/api/tsconfig.json
  - apps/api/src/index.ts
  - apps/api/src/routes/index.ts
  - apps/api/src/routes/decisions.ts
  - apps/api/src/lib/supabase.ts
  - apps/api/src/lib/assemblyai.ts
- **Learnings for future iterations:**
  - Backend app already existed with most setup done, needed workspace name and moduleResolution fixes
  - Use lazy initialization for external service clients to allow basic routes to work without env vars
  - moduleResolution: "bundler" means imports don't need .js extensions
  - Use `pnpm --filter @decisions/api dev` to run just the backend
  - Health endpoint is at /health and returns { status: 'ok', timestamp, uptime }
---

## 01/15/2026 - US-004
Iteration: 4
- What was implemented:
  - Verified: Tailwind CSS was already fully configured
  - Dependencies present: tailwindcss, postcss, autoprefixer
  - tailwind.config.js correctly configured with content paths
  - postcss.config.js properly set up
  - index.css has all @tailwind directives
  - Components (Login, Dashboard) extensively use Tailwind classes
- Files changed:
  - None (already complete)
- **Learnings for future iterations:**
  - Tailwind CSS was already configured in the codebase
  - CSS output is ~18KB showing Tailwind processing is working
  - Components use standard Tailwind classes (bg-*, text-*, p-*, rounded, etc.)
---

## 01/15/2026 - US-005
Iteration: 5
- What was implemented:
  - Created packages/types directory with @decisions/types package
  - Added package.json with proper main/types exports pointing to dist
  - Added tsconfig.json with declaration: true for .d.ts generation
  - Created User and UserProfile interfaces
  - Created database types: Decision, DecisionOption, OptionProCon, DecisionOutcome, FollowUpReminder
  - Created enum types: DecisionStatus, OutcomeRating, DecisionCategory, EmotionalState
  - Added @decisions/types as dependency to @decisions/web and @decisions/api
- Files changed:
  - packages/types/package.json (new)
  - packages/types/tsconfig.json (new)
  - packages/types/src/index.ts (new)
  - packages/types/src/database.ts (new)
  - apps/web/package.json
  - apps/api/package.json
- **Learnings for future iterations:**
  - Codebase already had @decisions/shared, so @decisions/types is an additional types package
  - Use declaration: true in tsconfig to generate .d.ts files
  - Package exports should point to dist/ for compiled output
  - Turborepo correctly handles new packages automatically
---

## 01/15/2026 - US-006
Iteration: 6
- What was implemented:
  - Created .prettierignore file with dist, node_modules, .turbo, coverage, build, .next, pnpm-lock.yaml
  - Created .gitattributes file for consistent LF line endings across all platforms
  - Verified existing .eslintrc.cjs with flat config for TypeScript and React
  - Verified existing .prettierrc with singleQuote: true, semi: true, tabWidth: 2
  - Verified turbo pipeline already includes 'lint' task
  - Verified all packages have lint scripts configured
  - Ran pnpm format to normalize all file formatting
  - All lint and format commands pass successfully
- Files changed:
  - .prettierignore (new)
  - .gitattributes (new)
  - Various source files (formatting normalization by Prettier)
- **Learnings for future iterations:**
  - ESLint and Prettier were mostly pre-configured, just needed .prettierignore
  - Use .gitattributes with text=auto eol=lf to ensure consistent line endings
  - pnpm format runs prettier on all matching files (ts, tsx, js, jsx, json, md)
  - React version detection warnings in non-React packages are harmless
---

## 01/15/2026 - US-007
Iteration: 7
- What was implemented:
  - Installed vitest v4.0.17 at root workspace and in both apps
  - Created apps/web/vitest.config.ts with jsdom environment and globals: true
  - Created apps/api/vitest.config.ts with node environment
  - Installed @testing-library/react, @testing-library/jest-dom, @testing-library/dom, jsdom in web app
  - Created apps/web/src/__tests__/setup.ts with jest-dom matchers
  - Created apps/web/src/__tests__/App.test.tsx with 2 placeholder tests
  - Created apps/api/src/__tests__/health.test.ts with 3 tests for health endpoint
  - Added "test" and "test:watch" scripts to both app package.json files
  - turbo.json already had test task in pipeline
  - All tests pass with `pnpm test` from root
- Files changed:
  - package.json (added vitest as root dev dependency)
  - pnpm-lock.yaml
  - apps/web/package.json (added test scripts and testing dependencies)
  - apps/web/vitest.config.ts (new)
  - apps/web/src/__tests__/setup.ts (new)
  - apps/web/src/__tests__/App.test.tsx (new)
  - apps/api/package.json (added test scripts and vitest)
  - apps/api/vitest.config.ts (new)
  - apps/api/src/__tests__/health.test.ts (new)
- **Learnings for future iterations:**
  - Vitest 4.x is latest stable version with good TypeScript support
  - Use jsdom environment for React component tests, node for API tests
  - @testing-library/jest-dom provides toBeInTheDocument() and similar matchers
  - Fastify's app.inject() method is useful for testing routes without HTTP
  - setupFiles in vitest.config.ts can point to a file that imports jest-dom matchers
  - React Router warnings about future flags are normal and don't affect test results
---

## 01/15/2026 - US-008
Iteration: 8
- What was implemented:
  - Created apps/e2e directory for Playwright E2E testing
  - Added package.json with @playwright/test v1.50.0
  - Created playwright.config.ts with:
    - baseURL: http://localhost:5173
    - webServer configuration to auto-start frontend and backend
    - HTML reporter in playwright-report/
    - Chromium as primary test browser (Firefox/WebKit commented but available)
  - Created tsconfig.json for TypeScript support in e2e tests
  - Created tests/example.spec.ts with 3 tests:
    - Redirect to login when not authenticated
    - Verify login page elements render correctly
    - Navigation from login to signup
  - Added test:e2e script to root package.json
  - Added placeholder lint script to e2e package for Turborepo compatibility
  - Installed Playwright Chromium browser
- Files changed:
  - apps/e2e/package.json (new)
  - apps/e2e/playwright.config.ts (new)
  - apps/e2e/tsconfig.json (new)
  - apps/e2e/tests/example.spec.ts (new)
  - package.json (added test:e2e script)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - Playwright 1.50.0 is the latest stable version
  - Use `pnpm --filter @decisions/e2e exec playwright install chromium` to install browser
  - webServer array in config can start multiple servers (api + web)
  - Use reuseExistingServer: !process.env.CI for dev/CI flexibility
  - E2E tests use getByRole, getByLabel for accessible queries
  - E2E package doesn't need build task but needs lint for Turborepo (can be echo placeholder)
---

## 01/15/2026 - US-009
Iteration: 9
- What was implemented:
  - Created apps/api/.env.example with all backend environment variables:
    - Server config: PORT, HOST, NODE_ENV, LOG_LEVEL, CORS_ORIGIN
    - Supabase config: SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
    - AI services: ASSEMBLYAI_API_KEY, OPENAI_API_KEY
  - Created apps/api/src/config/env.ts with:
    - Zod schema for environment validation
    - TypeScript type export (Env)
    - JSON Schema for @fastify/env (fastifyEnvSchema)
    - validateEnv() helper function
    - isSupabaseConfigured() and isAIConfigured() helpers
  - Updated apps/api/src/index.ts to:
    - Register @fastify/env plugin with dotenv: true
    - Use server.config for validated environment access
    - Extended FastifyInstance type with config property
  - Updated README.md with detailed environment variables documentation:
    - Separate sections for frontend and backend env files
    - Clear instructions on where to get API keys
    - Security note about SERVICE_ROLE_KEY
  - Verified .gitignore already includes .env and .env.local
- Files changed:
  - apps/api/.env.example (new)
  - apps/api/src/config/env.ts (new)
  - apps/api/src/index.ts (modified)
  - apps/api/package.json (added zod)
  - README.md (updated)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - @fastify/env uses JSON Schema, not Zod directly, so both schemas needed
  - ZodError uses .issues property (not .errors) for accessing validation errors
  - @fastify/env with dotenv: true auto-loads .env files
  - Use confKey option to specify where config is attached (server.config)
  - Extend FastifyInstance with declare module 'fastify' for TypeScript
---

## 01/15/2026 - US-010
Iteration: 10
- What was implemented:
  - Created packages/supabase directory with @decisions/supabase package
  - Added package.json with @supabase/supabase-js dependency
  - Created tsconfig.json with noEmit: false to enable compilation
  - Created src/client.ts with factory functions:
    - createClient: base configurable client
    - createBrowserClient: browser-safe client with anon key
    - createAdminClient: server-side client with service role key (bypasses RLS)
  - Created src/types.ts re-exporting common Supabase types
  - Created src/index.ts exporting all functions and types
  - Updated apps/web/src/lib/supabase.ts to use createBrowserClient from @decisions/supabase
  - Updated apps/api/src/lib/supabase.ts to use createAdminClient from @decisions/supabase
  - Updated apps/web/src/contexts/AuthContext.tsx to import types from @decisions/supabase
  - Added @decisions/supabase as workspace dependency in both apps
  - Removed direct @supabase/supabase-js dependency from apps (now via shared package)
  - Used Proxy pattern for lazy initialization in web supabase client
- Files changed:
  - packages/supabase/package.json (new)
  - packages/supabase/tsconfig.json (new)
  - packages/supabase/src/client.ts (new)
  - packages/supabase/src/types.ts (new)
  - packages/supabase/src/index.ts (new)
  - apps/web/package.json (modified)
  - apps/web/src/lib/supabase.ts (modified)
  - apps/web/src/contexts/AuthContext.tsx (modified)
  - apps/api/package.json (modified)
  - apps/api/src/lib/supabase.ts (modified)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - tsconfig.base.json has noEmit: true, packages must override with noEmit: false
  - When exporting getter objects, TypeScript infers complex types; use Proxy with explicit type annotation
  - Supabase types can be re-exported from shared package for consistency
  - createAdminClient should disable autoRefreshToken and persistSession for server use
  - Database already has tables: profiles, categories, decisions, options, pros_cons
  - Project URL: https://doqojfsldvajmlscpwhu.supabase.co
---

## 01/15/2026 - US-011
Iteration: 11
- What was implemented:
  - Created supabase/migrations directory structure
  - Created 001_users_profile.sql migration file with:
    - DecisionsUserProfiles table with id (uuid PK ref auth.users), display_name, avatar_url, onboarding_completed, created_at, updated_at
    - update_updated_at_column() trigger function
    - RLS enabled on table
    - RLS policies for SELECT, INSERT, UPDATE (users access own profile only)
    - Trigger on UPDATE for automatic updated_at timestamp
  - Applied migration to Supabase via MCP (success)
  - Verified table exists with SELECT query (empty result, no errors)
  - Verified RLS policies: Users can view/create/update their own profile
  - Verified trigger: update_decisions_user_profiles_updated_at on UPDATE
  - Security advisors show no issues with new table (RLS properly configured)
- Files changed:
  - supabase/migrations/001_users_profile.sql (new)
- **Learnings for future iterations:**
  - Supabase migrations are stored in supabase/migrations/*.sql
  - Use (SELECT auth.uid()) = id for RLS policies (wrapped select for performance)
  - update_updated_at_column() is a reusable trigger function for all tables
  - Case-sensitive table names in PostgreSQL require double quotes ("DecisionsUserProfiles")
  - Existing `profiles` table coexists with new `DecisionsUserProfiles` table
  - apply_migration MCP tool is the primary way to run DDL operations
---

## 01/15/2026 - US-012
Iteration: 12
- What was implemented:
  - Created supabase/migrations/002_enums.sql with PostgreSQL ENUM types:
    - decision_status: draft, in_progress, decided, outcome_recorded
    - outcome_rating: better_than_expected, as_expected, worse_than_expected
    - decision_category: career, financial, relationship, health, lifestyle, other
  - Added missing values (draft, outcome_recorded) to pre-existing decision_status enum
  - Created packages/types/src/enums.ts with:
    - TypeScript union types for all enums
    - Constant arrays for validation (DECISION_STATUS_VALUES, etc.)
  - Refactored packages/types/src/database.ts to import enums from enums.ts
  - Updated packages/types/src/index.ts to export from enums module
  - Applied migration via Supabase MCP and verified with enum_range queries
  - pnpm build and pnpm lint pass successfully
- Files changed:
  - supabase/migrations/002_enums.sql (new)
  - packages/types/src/enums.ts (new)
  - packages/types/src/database.ts (modified)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - PostgreSQL ENUMs may already exist from previous work; use IF NOT EXISTS pattern
  - ALTER TYPE ... ADD VALUE IF NOT EXISTS can add values to existing enums
  - Cannot remove enum values without dropping and recreating the type
  - TypeScript union types are preferred over enums for better type inference
  - Providing constant arrays (e.g., DECISION_STATUS_VALUES) is useful for runtime validation
---

## 01/15/2026 - US-013
Iteration: 13
- What was implemented:
  - Created supabase/migrations/003_decisions.sql migration file with:
    - DecisionsDecisions table with all required fields (id, user_id, title, description, status, category, emotional_state, audio_url, transcript, decided_at, created_at, updated_at)
    - Proper defaults: gen_random_uuid() for id, 'draft' for status, 'other' for category, now() for timestamps
    - FK constraint: user_id references auth.users(id) ON DELETE CASCADE
  - Created indexes on: user_id, status, category, created_at DESC
  - Enabled RLS with 4 policies: SELECT, INSERT, UPDATE, DELETE (users access only their own data)
  - Trigger for automatic updated_at using existing update_updated_at_column() function
  - Applied migration via Supabase MCP (success)
  - Created packages/types/src/decision.ts with:
    - DecisionsDecision interface (camelCase)
    - DecisionsDecisionRow interface (snake_case for DB)
    - Helper functions: toDecisionsDecision(), toDecisionsDecisionRow()
    - Input types: CreateDecisionsDecisionInput, UpdateDecisionsDecisionInput
  - Updated packages/types/src/index.ts to export from decision module
  - Verified table structure via MCP query
  - pnpm build and pnpm lint pass successfully
- Files changed:
  - supabase/migrations/003_decisions.sql (new)
  - packages/types/src/decision.ts (new)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - Database already has a `decisions` table with different structure; PRD uses "Decisions" prefix pattern
  - Reusing update_updated_at_column() function created in 001_users_profile.sql
  - Creating both camelCase TypeScript types and snake_case row types helps with DB operations
  - Include helper functions for type conversion (toEntity/toRow) in type modules
---

## 01/15/2026 - US-014
Iteration: 14
- What was implemented:
  - Created supabase/migrations/004_decision_options.sql with:
    - DecisionsDecisionOptions table with all required fields (id, decision_id, title, description, is_chosen, order_index, created_at, updated_at)
    - FK constraint on decision_id referencing DecisionsDecisions(id) ON DELETE CASCADE
    - Index on decision_id for efficient joins
    - RLS policies (SELECT, INSERT, UPDATE, DELETE) based on ownership through parent decision
    - Trigger for automatic updated_at using existing update_updated_at_column() function
  - Applied migration via Supabase MCP and verified:
    - Table structure correct
    - FK constraint exists (DecisionsDecisionOptions_decision_id_fkey)
    - Index idx_decisions_decision_options_decision_id created
    - 4 RLS policies with proper ownership chain checks
  - Created packages/types/src/decision-option.ts with:
    - DecisionsDecisionOption interface (camelCase)
    - DecisionsDecisionOptionRow interface (snake_case for DB)
    - Helper functions: toDecisionsDecisionOption(), toDecisionsDecisionOptionRow()
    - Input types: CreateDecisionsDecisionOptionInput, UpdateDecisionsDecisionOptionInput
  - Updated packages/types/src/index.ts to export from decision-option module
  - pnpm build and pnpm lint pass successfully
- Files changed:
  - supabase/migrations/004_decision_options.sql (new)
  - packages/types/src/decision-option.ts (new)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - RLS for child tables uses EXISTS subquery to check ownership via parent table
  - The pattern `EXISTS (SELECT 1 FROM parent WHERE parent.id = child.parent_id AND parent.user_id = auth.uid())` works well for nested ownership
  - TypeScript type file naming: use kebab-case (decision-option.ts) matching the entity name
---

## 01/15/2026 - US-015
Iteration: 15
- What was implemented:
  - Created supabase/migrations/005_option_pros_cons.sql with:
    - DecisionsOptionProsCons table with all required fields (id, option_id, content, is_pro, weight, order_index, created_at, updated_at)
    - FK constraint on option_id referencing DecisionsDecisionOptions(id) ON DELETE CASCADE
    - CHECK constraint for weight range (1-5): `weight >= 1 AND weight <= 5`
    - Index on option_id for efficient joins
    - RLS policies (SELECT, INSERT, UPDATE, DELETE) using ownership chain through option -> decision -> user
    - Trigger for automatic updated_at using existing update_updated_at_column() function
  - Applied migration via Supabase MCP and verified:
    - Table structure correct with all 8 columns
    - FK, PK, and CHECK constraints exist
    - Index idx_decisions_option_pros_cons_option_id created
    - 4 RLS policies with proper ownership chain checks
  - Created packages/types/src/option-pro-con.ts with:
    - DecisionsOptionProCon interface (camelCase)
    - DecisionsOptionProConRow interface (snake_case for DB)
    - Helper functions: toDecisionsOptionProCon(), toDecisionsOptionProConRow()
    - Input types: CreateDecisionsOptionProConInput, UpdateDecisionsOptionProConInput
  - Updated packages/types/src/index.ts to export from option-pro-con module
  - pnpm build and pnpm lint pass successfully
- Files changed:
  - supabase/migrations/005_option_pros_cons.sql (new)
  - packages/types/src/option-pro-con.ts (new)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - For deeply nested RLS (grandchild tables), use INNER JOIN pattern: `EXISTS (SELECT 1 FROM child INNER JOIN parent ON ... WHERE child.id = grandchild.child_id AND parent.user_id = auth.uid())`
  - CHECK constraints in PostgreSQL: `CHECK (field >= min AND field <= max)` for range validation
  - Continue using kebab-case for TypeScript type file names (option-pro-con.ts)
---

## 01/15/2026 - US-016
Iteration: 16
- What was implemented:
  - Created supabase/migrations/006_decision_outcomes.sql with:
    - DecisionsDecisionOutcomes table with all required fields (id, decision_id, rating, notes, audio_url, transcript, recorded_at, created_at, updated_at)
    - FK constraint on decision_id referencing DecisionsDecisions(id) ON DELETE CASCADE
    - UNIQUE constraint on decision_id (one outcome per decision)
    - rating field uses outcome_rating ENUM type
    - Nullable fields: notes, audio_url, transcript
    - Index on decision_id (implicit from UNIQUE constraint)
    - RLS policies (SELECT, INSERT, UPDATE, DELETE) based on ownership through parent decision
    - Trigger for automatic updated_at using existing update_updated_at_column() function
  - Applied migration via Supabase MCP and verified:
    - Table structure with all 9 columns
    - 3 constraints: PK on id, FK on decision_id, UNIQUE on decision_id
    - 4 RLS policies with proper ownership chain checks
  - Created packages/types/src/decision-outcome.ts with:
    - DecisionsDecisionOutcome interface (camelCase)
    - DecisionsDecisionOutcomeRow interface (snake_case for DB)
    - Helper functions: toDecisionsDecisionOutcome(), toDecisionsDecisionOutcomeRow()
    - Input types: CreateDecisionsDecisionOutcomeInput, UpdateDecisionsDecisionOutcomeInput
  - Updated packages/types/src/index.ts to export from decision-outcome module
  - pnpm build and pnpm lint pass successfully
- Files changed:
  - supabase/migrations/006_decision_outcomes.sql (new)
  - packages/types/src/decision-outcome.ts (new)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - For one-to-one relationships, UNIQUE constraint on FK column enforces single child record per parent
  - RLS for child tables with FK to parent: use simple EXISTS subquery (no JOINs needed for direct parent relationship)
  - outcome_rating ENUM type was created in 002_enums.sql and can be used directly in table definition
  - UNIQUE constraint automatically creates an implicit index on the column
---

## 01/15/2026 - US-017
Iteration: 17
- What was implemented:
  - Created supabase/migrations/007_followup_reminders.sql with:
    - DecisionsFollowUpReminders table with all required fields (id, decision_id, scheduled_for, sent_at, is_dismissed, created_at, updated_at)
    - FK constraint on decision_id referencing DecisionsDecisions(id) ON DELETE CASCADE
    - 3 indexes: decision_id, scheduled_for, sent_at (for querying upcoming and unsent reminders)
    - is_dismissed boolean field with default false
    - sent_at nullable field to track when reminder was actually sent
    - RLS policies (SELECT, INSERT, UPDATE, DELETE) using ownership chain through parent decision
    - Trigger for automatic updated_at using existing update_updated_at_column() function
  - Applied migration via Supabase MCP and verified:
    - Table structure with all 7 columns
    - 4 indexes (PK + 3 explicit indexes)
    - 4 RLS policies with proper ownership chain checks
  - Created packages/types/src/followup-reminder.ts with:
    - DecisionsFollowUpReminder interface (camelCase)
    - DecisionsFollowUpReminderRow interface (snake_case for DB)
    - Helper functions: toDecisionsFollowUpReminder(), toDecisionsFollowUpReminderRow()
    - Input types: CreateDecisionsFollowUpReminderInput, UpdateDecisionsFollowUpReminderInput
  - Updated packages/types/src/index.ts to export from followup-reminder module
  - pnpm build and pnpm lint pass successfully
- Files changed:
  - supabase/migrations/007_followup_reminders.sql (new)
  - packages/types/src/followup-reminder.ts (new)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - Unlike DecisionOutcomes (one-to-one), FollowUpReminders can have multiple reminders per decision (one-to-many)
  - Multiple indexes on the same table are fine for different query patterns (decision_id for filtering by decision, scheduled_for for finding upcoming, sent_at for finding unsent)
  - RLS pattern for child tables: EXISTS (SELECT 1 FROM parent WHERE parent.id = child.fk AND parent.user_id = auth.uid())
  - Continue using kebab-case for TypeScript type file names (followup-reminder.ts)
---

## 01/15/2026 - US-018
Iteration: 18
- What was implemented:
  - Created packages/types/src/api.ts with comprehensive API request/response types:
    - Common types: ApiError, PaginationMeta, PaginatedResponse<T>
    - Decision request types: CreateDecisionRequest, UpdateDecisionRequest, ListDecisionsQuery, MarkAsDecidedRequest
    - Decision response types: DecisionResponse, DecisionListResponse, DecisionSummary, DecisionOptionWithProsCons
    - Nested creation types: CreateOptionInput, UpdateOptionInput, CreateProConInput
    - Outcome types: RecordOutcomeRequest, UpdateOutcomeRequest, OutcomeResponse
    - Reminder types: CreateReminderRequest, UpdateReminderRequest, ReminderResponse, ReminderListResponse
    - Profile types: CreateProfileRequest, UpdateProfileRequest, ProfileResponse
    - Stats types: StatsOverviewResponse, StatusCount, CategoryCount, OutcomeRatingCount
    - Audio types: AudioUploadResponse, TranscriptionRequest, TranscriptionResponse
    - Extraction types: ExtractedDecision, ExtractedOption, ExtractedProCon, ExtractionRequest
  - Updated packages/types/src/index.ts to export from api module
  - pnpm build and pnpm lint pass successfully
  - Verified imports work from both apps/web and apps/api
- Files changed:
  - packages/types/src/api.ts (new)
  - packages/types/src/index.ts (modified)
- **Learnings for future iterations:**
  - API types should be separate from database entity types for cleaner separation
  - Use Omit and Partial utility types for request input types
  - Use PaginatedResponse<T> generic for consistent pagination across list endpoints
  - DecisionResponse extends DecisionsDecision to include nested relations (options, outcome, reminders)
  - DecisionSummary is a lightweight type for list views without full nested data
---

## 01/15/2026 - US-019
Iteration: 19
- What was implemented:
  - Created supabase/migrations/008_storage_bucket_audio.sql with:
    - decision-audio bucket with private access (public: false)
    - File size limit: 10MB (10485760 bytes)
    - Allowed MIME types: audio/webm, audio/mp4, audio/mpeg, audio/wav
    - RLS policy for INSERT: Users can upload to their own folder ({user_id}/)
    - RLS policy for SELECT: Users can read only their own files
    - RLS policy for UPDATE: Users can update their own files (for upsert)
    - RLS policy for DELETE: Users can delete their own files
  - Applied migration via Supabase MCP (success)
  - Verified bucket configuration: public=false, file_size_limit=10MB, allowed_mime_types correct
  - Verified all 4 RLS policies exist with proper ownership checks using storage.foldername(name)
  - Security advisors show no issues with new storage configuration
- Files changed:
  - supabase/migrations/008_storage_bucket_audio.sql (new)
- **Learnings for future iterations:**
  - Supabase Storage uses storage.buckets table to store bucket config
  - Use storage.foldername(name)[1] to extract user folder from path for RLS checks
  - Cast auth.uid() to text (auth.uid()::text) when comparing with folder name
  - Use ON CONFLICT DO UPDATE for idempotent bucket creation
  - RLS policies on storage.objects table control access to files in buckets
  - Private buckets (public: false) require RLS policies to allow any access
---

## 01/15/2026 - US-020
Iteration: 20
- What was implemented:
  - Installed @fastify/jwt v8.x (compatible with Fastify 4.x, note: v9.x+ requires Fastify 5.x)
  - Added fastify-plugin for proper encapsulation handling
  - Created apps/api/src/plugins/auth.ts with:
    - JWTUser interface for user payload from Supabase JWT
    - SupabaseJWTPayload interface matching Supabase Auth JWT structure
    - Auth plugin that registers @fastify/jwt with SUPABASE_JWT_SECRET
    - `authenticate` decorator for protecting routes (preHandler hook)
    - Extracts user info from JWT 'sub' claim to request.jwtUser
    - Returns 401 Unauthorized for invalid/missing/expired tokens
  - Created apps/api/src/routes/users.ts with GET /api/me endpoint:
    - Protected by fastify.authenticate preHandler
    - Returns user info: id, email, phone, role, aal, session_id, app/user metadata
  - Updated apps/api/src/config/env.ts with SUPABASE_JWT_SECRET env variable
  - Updated apps/api/.env.example with SUPABASE_JWT_SECRET documentation
  - Created comprehensive tests in apps/api/src/__tests__/auth.test.ts:
    - Test valid token returns 200 with user info
    - Test no token returns 401
    - Test invalid token returns 401
    - Test expired token returns 401
    - Test wrong auth header format returns 401
    - Test token signed with wrong secret returns 401
    - Test minimal user info when only sub/email in token
- Files changed:
  - apps/api/package.json (added @fastify/jwt, fastify-plugin)
  - apps/api/src/config/env.ts (added SUPABASE_JWT_SECRET)
  - apps/api/.env.example (added SUPABASE_JWT_SECRET)
  - apps/api/src/index.ts (registered auth plugin)
  - apps/api/src/routes/index.ts (added users routes)
  - apps/api/src/plugins/auth.ts (new)
  - apps/api/src/routes/users.ts (new)
  - apps/api/src/__tests__/auth.test.ts (new)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - @fastify/jwt version mapping: v8.x for Fastify 4.x, v9.x+ for Fastify 5.x
  - @fastify/jwt decorates request with 'user' by default; use decoratorName option to customize
  - Use fastify-plugin (fp) to wrap plugins that should not be encapsulated
  - Supabase JWT structure: sub = user ID, email, phone, role, aal, session_id, app_metadata, user_metadata
  - For expired token tests, set exp claim manually instead of negative expiresIn (fast-jwt doesn't support negative values)
  - Test JWT verification by creating separate Fastify instance with different secret
---

## 01/15/2026 - US-021
Iteration: 21
- What was implemented:
  - Updated AuthContext interface with renamed methods: signIn, signUp (from signInWithEmail, signUpWithEmail)
  - Added JSDoc comments for all auth methods
  - Moved AuthProvider from App.tsx to main.tsx to wrap entire app
  - Simplified App.tsx routing structure: removed nested HomePage component
  - All routes now have direct access to AuthContext through main.tsx wrapper
  - Created comprehensive unit test suite for AuthContext (11 tests):
    - Shows loading state initially
    - Shows no user when not authenticated
    - Shows user when authenticated
    - Updates state when onAuthStateChange fires
    - Calls signInWithPassword when signIn is called
    - Calls signUp when signUp is called
    - Calls signInWithOAuth with google provider when signInWithGoogle is called
    - Calls signOut when signOut is called
    - Throws error when signIn fails
    - Unsubscribes from auth state changes on unmount
    - Throws error when useAuth is used outside AuthProvider
  - Updated Login.tsx and Signup.tsx to use new method names (signIn, signUp)
  - Installed @testing-library/user-event for test interactions
- Files changed:
  - apps/web/src/contexts/AuthContext.tsx (modified)
  - apps/web/src/main.tsx (modified - added AuthProvider)
  - apps/web/src/App.tsx (simplified routing)
  - apps/web/src/pages/Login.tsx (updated method call)
  - apps/web/src/pages/Signup.tsx (updated method call)
  - apps/web/src/__tests__/AuthContext.test.tsx (new)
  - apps/web/package.json (added @testing-library/user-event)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - AuthProvider should wrap the entire app at main.tsx level for consistent access
  - Nested routing in React Router should avoid re-declaring providers
  - @testing-library/user-event is useful for simulating user interactions in tests
  - vi.mock() must be called before importing the mocked module in Vitest
  - AuthChangeEvent type is not exported from @decisions/supabase - define locally if needed
  - Use let variable with type annotation for capturing values in async test closures
---

## 01/15/2026 - US-022
Iteration: 22
- What was implemented:
  - Updated Login.tsx with app branding: Decision Journal logo and name
  - Translated entire UI to Italian:
    - "Accedi al tuo account" subtitle
    - "Non hai un account? Registrati" registration link
    - "Accedi" submit button
    - "Accedi con Google" OAuth button
    - "Oppure continua con" separator text
    - Email/password placeholders in Italian
  - Added SVG lightbulb icon as app logo in a circular blue container
  - Improved error handling with Italian error messages:
    - "Email o password non validi" for invalid credentials
    - "Errore di connessione" for network errors
  - Created comprehensive unit test suite (15 tests):
    - Rendering tests for logo, form elements, links
    - Loading state tests (initial auth check, form submission)
    - Error state tests (invalid credentials, network errors, OAuth errors)
    - Redirect behavior when authenticated
    - Form submission tests for email and Google login
    - Input disable tests during submission
  - Updated Playwright E2E tests (7 tests):
    - Tests for Italian UI elements
    - Screenshot tests for desktop and mobile viewports
    - Responsive design verification
- Files changed:
  - apps/web/src/pages/Login.tsx (modified)
  - apps/web/src/__tests__/Login.test.tsx (new)
  - apps/e2e/tests/example.spec.ts (modified)
- **Learnings for future iterations:**
  - Use page.screenshot() instead of toHaveScreenshot() for first-time screenshot tests (avoids baseline issues)
  - Italian error messages should map common Supabase error patterns (Invalid login credentials, network)
  - Login component already had robust functionality; main changes were branding and localization
  - Route links should match existing app routing (/signup vs /register - use what exists in App.tsx)
---


## 01/15/2026 - US-023
Iteration: 23
- What was implemented:
  - Added client-side form validation to Login.tsx:
    - Email format validation with regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    - Password minimum length validation (6 characters)
    - Custom Italian error messages: "Email obbligatoria", "Inserisci un'email valida", "Password obbligatoria", "La password deve contenere almeno 6 caratteri"
  - Implemented inline error display:
    - Red border on invalid fields (border-red-300, focus:ring-red-500)
    - Error messages displayed below each field with red text
    - ARIA attributes for accessibility (aria-invalid, aria-describedby)
  - Errors clear automatically when user starts typing in field
  - Removed native HTML required attribute (replaced with custom validation)
  - Form prevents submission until all validation passes
  - Added 7 new unit tests for validation scenarios:
    - Empty email error
    - Invalid email format error
    - Empty password error
    - Short password error
    - Clear email error on typing
    - Clear password error on typing
    - Allow submission after fixing errors
  - Added 8 E2E tests for login form:
    - Validation error for empty email
    - Validation error for invalid email format
    - Validation error for empty password
    - Validation error for short password
    - Clear validation errors when typing
    - Error message for invalid credentials
    - Loading state during submission
    - Successful form submission (passes validation)
- Files changed:
  - apps/web/src/pages/Login.tsx (modified)
  - apps/web/src/__tests__/Login.test.tsx (modified)
  - apps/e2e/tests/example.spec.ts (modified)
- **Learnings for future iterations:**
  - Native HTML5 email validation (type="email") blocks form submission before custom validation runs for invalid formats like "test" (no @)
  - For testing invalid email format, use values that pass native validation but fail custom regex (e.g., "test@domain" missing TLD)
  - Use Proxy<T> pattern for type-safe state updates when clearing individual field errors
  - Input aria-invalid and aria-describedby improve accessibility for screen readers
  - Keep PASSWORD_MIN_LENGTH as constant for easy configuration
---


## 01/15/2026 - US-024
Iteration: 24
- What was implemented:
  - Verified Google OAuth implementation already existed in AuthContext:
    - signInWithGoogle method calls supabase.auth.signInWithOAuth({ provider: 'google' })
    - redirectTo option properly configured to redirect to /dashboard after OAuth
    - Error handling throws error which is caught by handleGoogleLogin in Login.tsx
  - Verified Login.tsx handleGoogleLogin:
    - Calls signInWithGoogle from AuthContext
    - Shows Italian error message on OAuth failure
    - Disables form during OAuth submission
  - Added 3 new E2E tests for Google OAuth in example.spec.ts:
    - Test 'should trigger OAuth redirect when clicking Google login button':
      - Clicks Google button and verifies page navigates to OAuth URL
      - Uses waitForURL to detect redirect to Google/Supabase auth or error page
    - Test 'should show Google login button with correct styling':
      - Verifies button has white background and Google icon SVG
    - Test 'should disable Google button during form submission':
      - Verifies Google button is disabled while email form submits
  - Improved screenshot tests to handle Playwright protocol errors:
    - Removed fullPage: true option which caused issues on Windows
    - Wrapped screenshot calls in try-catch with console.log fallback
    - Assertions before screenshot ensure test validity regardless of screenshot success
- Files changed:
  - apps/e2e/tests/example.spec.ts (modified - added 3 OAuth tests, improved screenshot handling)
- **Learnings for future iterations:**
  - OAuth implementations trigger page navigation away from the app, so can't assert on local elements after click
  - Use page.waitForURL with predicate function to detect OAuth redirects
  - Playwright screenshot with fullPage: true may fail on Windows with "Protocol error"
  - Use try-catch around screenshots to make tests resilient when screenshots aren't critical
  - Test OAuth flow by verifying navigation occurs, not by mocking the OAuth provider
---


## 01/15/2026 - US-025
Iteration: 25
- What was implemented:
  - Updated apps/web/src/pages/Signup.tsx with full page redesign:
    - Added app logo (lightbulb icon in blue circle) and "Decision Journal" branding
    - Translated all UI text to Italian (labels, placeholders, buttons, error messages)
    - Added name field (optional) marked with "(opzionale)" label
    - Email, password, confirm password fields with inline validation
    - "Crea Account" submit button with loading state
    - "Registrati con Google" OAuth button
    - "Hai giÃ  un account? Accedi" link to /login
  - Updated AuthContext.tsx:
    - Extended signUp method to accept optional displayName parameter
    - Passes displayName as user_metadata to Supabase signUp
  - Created comprehensive unit test suite (27 tests):
    - Rendering tests for all UI elements
    - Loading state tests
    - Error state tests for various failure scenarios
    - Redirect behavior when authenticated
    - Form validation tests for all fields
    - Clear error on typing tests
    - Form submission tests with/without display name
- Files changed:
  - apps/web/src/pages/Signup.tsx (redesigned)
  - apps/web/src/contexts/AuthContext.tsx (modified signUp)
  - apps/web/src/__tests__/Signup.test.tsx (new - 27 tests)
- **Learnings for future iterations:**
  - PRD mentioned /register but App.tsx already had /signup route - use existing routes
  - Signup page validation has stricter rules than login (8 chars + number for signup vs 6 chars for login)
  - Use screen.getByLabelText(/^password$/i) for exact match when there are multiple password fields
  - displayName can be passed to Supabase via options.data in signUp call
  - Test patterns from Login.test.tsx can be reused/adapted for Signup.test.tsx
---


## 01/15/2026 - US-026
Iteration: 26
- What was implemented:
  - Verified all acceptance criteria were already met by US-025 implementation
  - Signup page has complete validation: email format, password min 8 chars + number, password match
  - Submit calls supabase.auth.signUp correctly with optional displayName
  - Success shows "Controlla la tua email" message when email confirmation required
  - Auto-redirect to /onboarding when email confirmation disabled (session returned)
  - Error handling for "already registered" email and network errors
  - E2E tests cover full registration flow (32 tests total in example.spec.ts)
  - Unit tests: 27 Signup tests + 22 Login tests + 13 AuthContext tests = 62 total
- Files changed:
  - ralph/prd.json (marked US-026 as passes: true)
  - ralph/progress.txt (this entry)
- **Learnings for future iterations:**
  - Sometimes stories are already complete from previous work - always verify before implementing
  - US-025 (UI) and US-026 (functionality) were tightly coupled and implemented together
  - Run full test suite (unit + E2E) to verify acceptance criteria before marking complete
---


## 01/15/2026 - US-027
Iteration: 27
- What was implemented:
  - Verified POST /api/users/profile endpoint was already implemented in apps/api/src/routes/users.ts
  - Endpoint accepts { displayName?: string } body, creates profile in DecisionsUserProfiles
  - Returns 201 with ProfileResponse on success
  - Returns 409 Conflict if profile already exists (checked via SELECT before INSERT)
  - Handles race condition (unique constraint violation 23505) with 409 response
  - Returns 500 for unexpected database errors with appropriate messages
  - Created comprehensive unit test suite (10 tests) in apps/api/src/__tests__/users.test.ts:
    - Test 201 with displayName
    - Test 201 without displayName
    - Test 409 from existing profile (select check)
    - Test 409 from race condition (insert unique violation)
    - Test 500 for select error
    - Test 500 for insert error
    - Test 401 without token
    - Test 401 with invalid token
    - Test empty body handling
    - Test snake_case to camelCase field mapping
  - Used vi.mock() to mock getSupabase() with chainable mock methods
  - Verified DecisionsUserProfiles table structure via Supabase MCP
  - Verified RLS policies (SELECT, INSERT, UPDATE) via Supabase MCP
- Files changed:
  - apps/api/src/__tests__/users.test.ts (new - 10 tests)
  - ralph/prd.json (marked US-027 as passes: true)
  - ralph/progress.txt (this entry)
- **Learnings for future iterations:**
  - The endpoint was already implemented in users.ts; only tests were needed
  - Use vi.mock() before imports when mocking modules in Vitest
  - Mock Supabase client with chainable methods: from() -> select()/insert() -> eq() -> single()
  - PGRST116 is the Supabase error code for "no rows found" - not a real error
  - 23505 is PostgreSQL unique constraint violation error code
  - ProfileResponse uses camelCase (displayName, avatarUrl), DB uses snake_case (display_name, avatar_url)
---


## 01/15/2026 - US-028
Iteration: 28
- What was implemented:
  - Added GET /api/users/profile endpoint in apps/api/src/routes/users.ts
  - Endpoint is protected by fastify.authenticate preHandler
  - Returns 200 with ProfileResponse when profile exists
  - Returns 404 "Profile not found for this user" when profile doesn't exist (PGRST116)
  - Returns 500 "Failed to fetch profile" for database errors
  - Returns 401 Unauthorized for unauthenticated requests
  - Response includes: id, displayName, avatarUrl, onboardingCompleted, createdAt, updatedAt
  - Created 7 comprehensive unit tests in apps/api/src/__tests__/users.test.ts:
    - Test 200 with profile when profile exists
    - Test 200 when displayName and avatarUrl are null (optional fields)
    - Test 404 when profile does not exist
    - Test 500 when database query fails
    - Test 401 when no token is provided
    - Test 401 when invalid token is provided
    - Test snake_case to camelCase field mapping
- Files changed:
  - apps/api/src/routes/users.ts (modified - added GET endpoint)
  - apps/api/src/__tests__/users.test.ts (modified - added 7 tests)
  - ralph/prd.json (marked US-028 as passes: true)
- **Learnings for future iterations:**
  - GET profile follows same pattern as POST profile: use Supabase client, handle PGRST116 for not found
  - Response field mapping from snake_case DB columns to camelCase API response is standard
  - Use `|| undefined` to convert null DB values to undefined in response (for optional fields)
  - Test suite now has 17 tests for users endpoints (10 POST + 7 GET)
---


## 01/15/2026 - US-029
Iteration: 29
- What was implemented:
  - Created ProtectedRoute component in apps/web/src/components/AuthGuard.tsx
  - ProtectedRoute wraps children and redirects to /login when not authenticated
  - Supports optional redirectTo prop for custom redirect paths
  - Shows loading spinner while checking auth state (loading: true)
  - Uses useAuth() hook from AuthContext
  - Kept existing AuthGuard component for backward compatibility (uses Outlet pattern)
  - Created comprehensive unit test suite (10 tests) in apps/web/src/__tests__/ProtectedRoute.test.tsx:
    - Test loading state while auth is being checked
    - Test redirect to /login when not authenticated
    - Test redirect to custom path when redirectTo prop provided
    - Test renders children when authenticated
    - Test renders multiple children correctly
    - Test uses useAuth hook correctly
    - AuthGuard tests: loading state, redirect, render nested routes
- Files changed:
  - apps/web/src/components/AuthGuard.tsx (modified - added ProtectedRoute component)
  - apps/web/src/__tests__/ProtectedRoute.test.tsx (new - 10 tests)
  - ralph/prd.json (marked US-029 as passes: true)
- **Learnings for future iterations:**
  - AuthGuard already existed with Outlet pattern; ProtectedRoute is the children-wrapper pattern
  - Both patterns are valid in React Router v6: Outlet for nested routes, children for direct wrapping
  - Mock useAuth with vi.mock('../contexts/AuthContext') for ProtectedRoute tests
  - Use MemoryRouter with initialEntries for testing route redirects
  - useLocation() from react-router-dom is useful for verifying redirect paths in tests
  - Total web unit tests: 76 (including 10 new ProtectedRoute tests)
---


## 01/15/2026 - US-030
Iteration: 30
- What was implemented:
  - Updated Dashboard logout button text from "Sign out" to Italian "Esci"
  - Updated welcome message from "Welcome, [name]" to Italian "Ciao, [name]"
  - Updated error message to Italian "Errore durante il logout. Riprova."
  - Created comprehensive unit test suite (13 tests) in apps/web/src/__tests__/Dashboard.test.tsx:
    - Loading spinner while checking auth
    - Dashboard header with app title
    - Logout button with Italian text "Esci"
    - Welcome message with user name in Italian
    - User email in footer
    - signOut called when logout button clicked
    - Button disabled during logout
    - Loading spinner in button during logout
    - Error message on logout failure
    - Default Italian error message when error has no message
    - Re-enable button after logout error
    - Display name extracted from email correctly
    - "User" as default display name when email unavailable
  - Added 5 E2E tests for logout flow in apps/e2e/tests/example.spec.ts:
    - Display logout button in dashboard header
    - Redirect to login after successful logout
    - Loading state during logout
    - Welcome message with user name in Italian
    - Clear session and redirect to login on logout
- Files changed:
  - apps/web/src/pages/Dashboard.tsx (modified - Italian localization)
  - apps/web/src/__tests__/Dashboard.test.tsx (new - 13 tests)
  - apps/e2e/tests/example.spec.ts (modified - 5 new E2E tests)
  - ralph/prd.json (marked US-030 as passes: true)
- **Learnings for future iterations:**
  - Dashboard already had logout functionality; main work was Italian localization and tests
  - When mocking useAuth in vitest, use a factory function pattern to avoid hoisting issues
  - Use mockUseAuth.mockReturnValue() to override default mock for specific tests
  - Use getAllByText when text may appear multiple times (desktop + mobile views)
  - Session type requires token_type: 'bearer' as const for literal type compatibility
  - Total web unit tests: 89 (including 13 new Dashboard tests)
  - Total E2E tests: 37 (including 5 new logout tests)
---


## 01/15/2026 - US-031
Iteration: 1
- What was implemented:
  - Created Layout component (apps/web/src/components/Layout.tsx) with:
    - Header with logo (lightbulb icon) and app name "Decision Journal"
    - User avatar (from user_metadata.avatar_url) or initials fallback
    - Desktop dropdown menu with Profilo, Impostazioni, Esci links
    - Mobile hamburger menu with same options
    - Sticky header on mobile
    - Main content area with proper padding
    - Error notification area for logout failures
  - Created comprehensive unit tests (31 tests) in Layout.test.tsx:
    - Rendering tests (logo, avatar, initials, display name)
    - Desktop dropdown menu tests
    - Mobile menu tests
    - Logout functionality tests
    - Navigation link tests
    - Accessibility tests
  - Fixed TypeScript errors in Dashboard.test.tsx (User/Session type annotations)
- Files changed:
  - apps/web/src/components/Layout.tsx (new)
  - apps/web/src/__tests__/Layout.test.tsx (new)
  - apps/web/src/__tests__/Dashboard.test.tsx (type fixes)
- **Learnings for future iterations:**
  - Layout component closes both desktop dropdown and mobile menu immediately on logout start (setIsMenuOpen(false), setIsMobileMenuOpen(false))
  - User metadata accessed via user.user_metadata.display_name and user.user_metadata.avatar_url
  - Testing-library role queries: use aria-label for buttons without text content
  - Menu items in dropdown have role="menuitem", hamburger button needs descriptive aria-label
---


## 01/15/2026 - US-032
Iteration: 1
- What was implemented:
  - Renamed useVoiceRecorder hook to useMediaRecorder (git mv preserves history)
  - Added recordingTime as alias for duration per PRD specification
  - Updated interface name to UseMediaRecorderReturn with comprehensive JSDoc docs
  - Added backwards-compatible exports: useVoiceRecorder alias and UseVoiceRecorderReturn type
  - Updated VoiceCapture.tsx to use new hook import
  - Created comprehensive unit test suite (25 tests) in useMediaRecorder.test.ts:
    - Initial state tests (all values at defaults, recordingTime alias works)
    - startRecording tests (permission request, state reset, error handling)
    - stopRecording tests (provides audioBlob, error for short recordings)
    - pauseRecording/resumeRecording tests
    - resetRecording tests (clears all state)
    - Duration timer tests (increments, pauses correctly, alias works during recording)
    - Max duration auto-stop test (300 seconds)
    - MIME type support tests (webm preferred, mp4 fallback)
    - Backwards compatibility tests (useVoiceRecorder alias)
    - Cleanup tests (URL revocation, stream tracks)
- Files changed:
  - apps/web/src/hooks/useMediaRecorder.ts (renamed from useVoiceRecorder.ts)
  - apps/web/src/__tests__/useMediaRecorder.test.ts (new)
  - apps/web/src/pages/VoiceCapture.tsx (import updated)
- **Learnings for future iterations:**
  - Use globalThis cast to any (const g = globalThis as any) for mocking browser APIs in tests
  - MockMediaRecorder needs ondataavailable, onstop, onerror handlers and state management
  - vi.useFakeTimers() required for testing duration increments
  - MediaRecorder.isTypeSupported() should be mocked as static method on class
  - Hook already existed with full functionality - main work was renaming and adding alias
  - Backwards compatibility via export const useVoiceRecorder = useMediaRecorder
---

## 01/16/2026 - US-033
Iteration: 1
- What was implemented:
  - Created useAudioAnalyser hook in src/hooks/useAudioAnalyser.ts
  - Hook accepts MediaStream via startAnalysing(stream) function
  - Returns frequencyData (Uint8Array) and timeData (Uint8Array) for visualization
  - Uses AudioContext + AnalyserNode from Web Audio API
  - Updates data via requestAnimationFrame for smooth continuous updates
  - Configurable options: fftSize (default 256), minDecibels, maxDecibels, smoothingTimeConstant
  - Supports webkitAudioContext fallback for older browsers
  - Proper cleanup on unmount: cancels animation frame, disconnects nodes, closes AudioContext
  - Created comprehensive unit tests (27 tests) in useAudioAnalyser.test.ts:
    - Initial state tests (empty arrays, correct sizes based on fftSize)
    - startAnalysing tests (AudioContext creation, AnalyserNode setup, animation frame loop)
    - Error handling tests (unsupported browser, initialization errors)
    - stopAnalysing tests (cleanup, disconnect, close)
    - Unmount cleanup tests
    - Continuous update tests
    - webkitAudioContext fallback test
- Files changed:
  - apps/web/src/hooks/useAudioAnalyser.ts (new)
  - apps/web/src/__tests__/useAudioAnalyser.test.ts (new)
- **Learnings for future iterations:**
  - Web Audio API AnalyserNode.frequencyBinCount = fftSize / 2
  - Use Uint8Array<ArrayBuffer> explicit type for Web Audio API compatibility with newer TypeScript
  - To copy Uint8Array for React state, use new Uint8Array(length) + .set() instead of new Uint8Array(array)
  - Mock AudioContext by tracking instances in an array rather than using vi.fn() as constructor
  - AnalyserNode methods getByteFrequencyData/getByteTimeDomainData fill the provided array in-place
  - webkitAudioContext is still needed for some older browsers
---

## 01/16/2026 - US-034
Iteration: 1
- What was implemented:
  - Created WaveformVisualizer component in src/components/audio/WaveformVisualizer.tsx
  - Canvas-based rendering with animated vertical bars
  - Blue/purple gradient coloring using createLinearGradient (blue-500 -> indigo-500 -> violet-500)
  - 60fps animation using requestAnimationFrame loop
  - Responsive behavior using ResizeObserver to adapt to container size
  - High DPI support via devicePixelRatio scaling
  - Configurable props: barCount (32), minBarHeight (3), barGap (2), barRadius (2)
  - Idle state shows bars at minimum height
  - Active state animates bars proportional to frequency data
  - Accessibility: aria-label and role="img" on canvas
  - Created index.ts export file for audio components
  - Created comprehensive unit test suite (30 tests) in WaveformVisualizer.test.tsx:
    - Rendering tests (container, canvas, className, accessibility)
    - Canvas drawing tests (context, gradient, bars)
    - Animation tests (loop start/stop, frame continuation)
    - Idle state tests (minimum height bars)
    - Responsive behavior tests (ResizeObserver observe/disconnect)
    - Configurable props tests
    - High DPI support test
    - Edge cases (empty data, large data, barCount variations)
    - State transition tests
- Files changed:
  - apps/web/src/components/audio/WaveformVisualizer.tsx (new)
  - apps/web/src/components/audio/index.ts (new)
  - apps/web/src/__tests__/WaveformVisualizer.test.tsx (new)
- **Learnings for future iterations:**
  - Canvas rendering requires manual DPI scaling: multiply dimensions by devicePixelRatio
  - Use ResizeObserver for responsive canvas components instead of window resize events
  - Mock ResizeObserver by tracking instances in an array and calling their methods
  - ctx.roundRect() is used for rounded corners in canvas (modern browsers)
  - ESLint requires curly braces on all if statements (curly rule)
  - Sample frequency data by averaging ranges for smoother bar visualization
  - Animation loop: request new frame at end of draw if isActive
---

## 01/16/2026 - US-035
Iteration: 1
- What was implemented:
  - Created RecordButton component in src/components/audio/RecordButton.tsx
  - Props: onStart, onStop, isRecording, isDisabled, className
  - 80px circular button (w-20 h-20 rounded-full) with microphone SVG icon
  - Idle state: gray-100 background, gray-700 text, aria-label "Inizia registrazione"
  - Recording state: red-500 background, white text, aria-label "Ferma registrazione"
  - Pulse animation (animate-ping) with red-400 during recording
  - Touch-friendly: 80px exceeds 44px minimum touch target
  - Accessibility: aria-label, aria-pressed, focus:ring-4, focus:ring-offset-2
  - Keyboard support: Enter and Space keys trigger action
  - Disabled state: opacity-50, cursor-not-allowed, no pulse animation
  - Updated audio/index.ts to export RecordButton and RecordButtonProps
  - Created comprehensive unit test suite (43 tests) in RecordButton.test.tsx:
    - Rendering tests (button, icon, type="button", className)
    - Idle state tests (background, text color, aria-label, aria-pressed, no pulse)
    - Recording state tests (red background, white text, aria-label, pulse animation)
    - Click behavior tests (onStart/onStop called, disabled prevents calls)
    - Keyboard accessibility tests (Enter, Space, other keys)
    - Disabled state tests (disabled attr, cursor, opacity, no pulse)
    - Size and styling tests (dimensions, rounded, focus ring, transitions)
    - Microphone icon tests (aria-hidden, z-index, size)
    - State transition tests (idle->recording, recording->idle, enable->disable)
- Files changed:
  - apps/web/src/components/audio/RecordButton.tsx (new)
  - apps/web/src/components/audio/index.ts (modified)
  - apps/web/src/__tests__/RecordButton.test.tsx (new)
- **Learnings for future iterations:**
  - Use animate-ping Tailwind class for pulse effect instead of custom CSS animation
  - aria-pressed attribute is useful for toggle buttons to indicate current state
  - Microphone icon uses two SVG paths: one for the mic body, one for the base/stand
  - Button type="button" prevents unintended form submissions
  - z-10 on icon ensures it appears above the pulse animation layer
---
